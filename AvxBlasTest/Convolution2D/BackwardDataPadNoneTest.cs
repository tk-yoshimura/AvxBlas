using AvxBlas;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using System;
using System.Linq;

namespace AvxBlasTest.Connection2DTest {
    [TestClass]
    public class BackwardDataPadNoneTest {
        [TestMethod]
        public void SBackwardDataPadNoneTest() {
            float max_err = 0;

            foreach (uint n in new int[] { 1, 2 }) {
                foreach ((uint iw, uint ih) in new (uint, uint)[] { (1, 1), (1, 2), (4, 3), (5, 8), (16, 15), (17, 28), (32, 30) }) {
                    foreach ((uint kw, uint kh) in new (uint, uint)[] { (1, 1), (1, 3), (3, 1), (3, 3), (3, 5), (5, 3), (7, 7) }) {
                        if (iw < kw || ih < kh) {
                            continue;
                        }
                        uint ow = iw - kw + 1, oh = ih - kh + 1;

                        foreach ((uint ic, uint oc) in new (uint, uint)[] { (1, 1), (2, 3), (3, 2), (4, 5), (5, 4), (8, 10), (10, 8),
                                                                            (7, 16), (16, 7), (9, 24), (24, 9), (31, 32), (32, 31), (15, 64), (64, 15) }) {

                            float[] yval = (new float[ow * oh * oc * n]).Select((_, idx) => idx * 1e-3f).ToArray();
                            float[] wval = (new float[kw * kh * ic * oc]).Select((_, idx) => (idx + 1) * 1e-3f).Reverse().ToArray();

                            Map2D y = new((int)oc, (int)ow, (int)oh, (int)n, yval);
                            Filter2D w = new((int)ic, (int)kw, (int)kh, (int)oc, wval);

                            Map2D x = Reference(y, w, (int)iw, (int)kw, (int)ih, (int)kh);

                            Array<float> y_tensor = yval;
                            Array<float> w_tensor = wval;
                            Array<float> x_tensor = new(ic * iw * ih * n, zeroset: false);

                            Convolution2D.BackwardData(n, ic, oc, iw, ih, kw, kh, PadMode.None, y_tensor, w_tensor, x_tensor);

                            float[] x_expect = x.ToFloatArray();
                            float[] x_actual = x_tensor;

                            CollectionAssert.AreEqual(yval, (float[])y_tensor);
                            CollectionAssert.AreEqual(wval, (float[])w_tensor);

                            AssertError.Tolerance(x_expect, x_actual, 1e-8f, 1e-6f, ref max_err, $"NG: {ic},{oc},{iw},{ih},{kw},{kh},{n}");

                            Console.WriteLine($"OK: {ic},{oc},{iw},{ih},{kw},{kh},{n}");
                        }
                    }
                }
            }

            Console.WriteLine($"maxerr:{max_err}");
        }

        public static Map2D Reference(Map2D y, Filter2D w, int iw, int kw, int ih, int kh) {
            int inchannels = w.InChannels, outchannels = w.OutChannels, batch = y.Batch;
            int ow = iw - kw + 1, oh = ih - kh + 1;

            if (y.Width != ow || y.Height != oh) {
                throw new ArgumentException("mismatch shape");
            }

            Map2D x = new(inchannels, iw, ih, batch);

            for (int th = 0; th < batch; th++) {
                for (int ky = 0; ky < kh; ky++) {
                    for (int kx = 0; kx < kw; kx++) {
                        for (int oy = 0; oy < oh; oy++) {
                            for (int ox = 0; ox < ow; ox++) {
                                for (int outch = 0; outch < outchannels; outch++) {
                                    double v = y[outch, ox, oy, th];

                                    for (int inch = 0; inch < inchannels; inch++) {
                                        x[inch, kx + ox, ky + oy, th] += v * w[inch, kx, ky, outch];
                                    }
                                }
                            }
                        }
                    }
                }
            }

            return x;
        }

        [TestMethod]
        public void ReferenceTest() {
            int inchannels = 4, outchannels = 6;
            int kwidth = 3, kheight = 5, inwidth = 9, inheight = 13, batch = 2;
            int outwidth = inwidth - kwidth + 1, outheight = inheight - kheight + 1;

            float[] yval = (new float[outwidth * outheight * outchannels * batch]).Select((_, idx) => idx * 1e-3f).ToArray();
            float[] wval = (new float[kwidth * kheight * outchannels * inchannels]).Select((_, idx) => idx * 1e-3f).Reverse().ToArray();

            Map2D y = new(outchannels, outwidth, outheight, batch, yval);
            Filter2D w = new(inchannels, kwidth, kheight, outchannels, wval);

            Map2D x = Reference(y, w, inwidth, kwidth, inheight, kheight);

            float[] x_expect = {
                2.085000000e-03f, 2.070000000e-03f, 2.055000000e-03f, 2.040000000e-03f, 1.163400000e-02f, 1.156800000e-02f, 1.150200000e-02f, 1.143600000e-02f, 2.850300000e-02f, 2.835000000e-02f, 2.819700000e-02f, 2.804400000e-02f,
                5.064300000e-02f, 5.038200000e-02f, 5.012100000e-02f, 4.986000000e-02f, 7.278300000e-02f, 7.241400000e-02f, 7.204500000e-02f, 7.167600000e-02f, 9.492300000e-02f, 9.444600000e-02f, 9.396900000e-02f, 9.349200000e-02f,
                1.170630000e-01f, 1.164780000e-01f, 1.158930000e-01f, 1.153080000e-01f, 8.445000000e-02f, 8.402400000e-02f, 8.359800000e-02f, 8.317200000e-02f, 4.538100000e-02f, 4.515000000e-02f, 4.491900000e-02f, 4.468800000e-02f,
                5.665800000e-02f, 5.637600000e-02f, 5.609400000e-02f, 5.581200000e-02f, 1.268040000e-01f, 1.261680000e-01f, 1.255320000e-01f, 1.248960000e-01f, 2.101500000e-01f, 2.090880000e-01f, 2.080260000e-01f, 2.069640000e-01f,
                2.531340000e-01f, 2.518560000e-01f, 2.505780000e-01f, 2.493000000e-01f, 2.961180000e-01f, 2.946240000e-01f, 2.931300000e-01f, 2.916360000e-01f, 3.391020000e-01f, 3.373920000e-01f, 3.356820000e-01f, 3.339720000e-01f,
                3.820860000e-01f, 3.801600000e-01f, 3.782340000e-01f, 3.763080000e-01f, 2.661000000e-01f, 2.647440000e-01f, 2.633880000e-01f, 2.620320000e-01f, 1.386420000e-01f, 1.379280000e-01f, 1.372140000e-01f, 1.365000000e-01f,
                1.606950000e-01f, 1.598940000e-01f, 1.590930000e-01f, 1.582920000e-01f, 3.394620000e-01f, 3.377520000e-01f, 3.360420000e-01f, 3.343320000e-01f, 5.358690000e-01f, 5.331420000e-01f, 5.304150000e-01f, 5.276880000e-01f,
                5.984010000e-01f, 5.953500000e-01f, 5.922990000e-01f, 5.892480000e-01f, 6.609330000e-01f, 6.575580000e-01f, 6.541830000e-01f, 6.508080000e-01f, 7.234650000e-01f, 7.197660000e-01f, 7.160670000e-01f, 7.123680000e-01f,
                7.859970000e-01f, 7.819740000e-01f, 7.779510000e-01f, 7.739280000e-01f, 5.389020000e-01f, 5.361120000e-01f, 5.333220000e-01f, 5.305320000e-01f, 2.767590000e-01f, 2.753100000e-01f, 2.738610000e-01f, 2.724120000e-01f,
                3.111720000e-01f, 3.096000000e-01f, 3.080280000e-01f, 3.064560000e-01f, 6.435600000e-01f, 6.402720000e-01f, 6.369840000e-01f, 6.336960000e-01f, 9.965880000e-01f, 9.914400000e-01f, 9.862920000e-01f, 9.811440000e-01f,
                1.077372000e+00f, 1.071792000e+00f, 1.066212000e+00f, 1.060632000e+00f, 1.158156000e+00f, 1.152144000e+00f, 1.146132000e+00f, 1.140120000e+00f, 1.238940000e+00f, 1.232496000e+00f, 1.226052000e+00f, 1.219608000e+00f,
                1.319724000e+00f, 1.312848000e+00f, 1.305972000e+00f, 1.299096000e+00f, 8.968080000e-01f, 8.920800000e-01f, 8.873520000e-01f, 8.826240000e-01f, 4.567080000e-01f, 4.542720000e-01f, 4.518360000e-01f, 4.494000000e-01f,
                5.050650000e-01f, 5.024700000e-01f, 4.998750000e-01f, 4.972800000e-01f, 1.033050000e+00f, 1.027680000e+00f, 1.022310000e+00f, 1.016940000e+00f, 1.583235000e+00f, 1.574910000e+00f, 1.566585000e+00f, 1.558260000e+00f,
                1.680975000e+00f, 1.672110000e+00f, 1.663245000e+00f, 1.654380000e+00f, 1.778715000e+00f, 1.769310000e+00f, 1.759905000e+00f, 1.750500000e+00f, 1.876455000e+00f, 1.866510000e+00f, 1.856565000e+00f, 1.846620000e+00f,
                1.974195000e+00f, 1.963710000e+00f, 1.953225000e+00f, 1.942740000e+00f, 1.333770000e+00f, 1.326600000e+00f, 1.319430000e+00f, 1.312260000e+00f, 6.754650000e-01f, 6.717900000e-01f, 6.681150000e-01f, 6.644400000e-01f,
                7.381650000e-01f, 7.343100000e-01f, 7.304550000e-01f, 7.266000000e-01f, 1.494210000e+00f, 1.486320000e+00f, 1.478430000e+00f, 1.470540000e+00f, 2.267415000e+00f, 2.255310000e+00f, 2.243205000e+00f, 2.231100000e+00f,
                2.365155000e+00f, 2.352510000e+00f, 2.339865000e+00f, 2.327220000e+00f, 2.462895000e+00f, 2.449710000e+00f, 2.436525000e+00f, 2.423340000e+00f, 2.560635000e+00f, 2.546910000e+00f, 2.533185000e+00f, 2.519460000e+00f,
                2.658375000e+00f, 2.644110000e+00f, 2.629845000e+00f, 2.615580000e+00f, 1.784850000e+00f, 1.775160000e+00f, 1.765470000e+00f, 1.755780000e+00f, 8.984850000e-01f, 8.935500000e-01f, 8.886150000e-01f, 8.836800000e-01f,
                9.712650000e-01f, 9.661500000e-01f, 9.610350000e-01f, 9.559200000e-01f, 1.955370000e+00f, 1.944960000e+00f, 1.934550000e+00f, 1.924140000e+00f, 2.951595000e+00f, 2.935710000e+00f, 2.919825000e+00f, 2.903940000e+00f,
                3.049335000e+00f, 3.032910000e+00f, 3.016485000e+00f, 3.000060000e+00f, 3.147075000e+00f, 3.130110000e+00f, 3.113145000e+00f, 3.096180000e+00f, 3.244815000e+00f, 3.227310000e+00f, 3.209805000e+00f, 3.192300000e+00f,
                3.342555000e+00f, 3.324510000e+00f, 3.306465000e+00f, 3.288420000e+00f, 2.235930000e+00f, 2.223720000e+00f, 2.211510000e+00f, 2.199300000e+00f, 1.121505000e+00f, 1.115310000e+00f, 1.109115000e+00f, 1.102920000e+00f,
                1.204365000e+00f, 1.197990000e+00f, 1.191615000e+00f, 1.185240000e+00f, 2.416530000e+00f, 2.403600000e+00f, 2.390670000e+00f, 2.377740000e+00f, 3.635775000e+00f, 3.616110000e+00f, 3.596445000e+00f, 3.576780000e+00f,
                3.733515000e+00f, 3.713310000e+00f, 3.693105000e+00f, 3.672900000e+00f, 3.831255000e+00f, 3.810510000e+00f, 3.789765000e+00f, 3.769020000e+00f, 3.928995000e+00f, 3.907710000e+00f, 3.886425000e+00f, 3.865140000e+00f,
                4.026735000e+00f, 4.004910000e+00f, 3.983085000e+00f, 3.961260000e+00f, 2.687010000e+00f, 2.672280000e+00f, 2.657550000e+00f, 2.642820000e+00f, 1.344525000e+00f, 1.337070000e+00f, 1.329615000e+00f, 1.322160000e+00f,
                1.437465000e+00f, 1.429830000e+00f, 1.422195000e+00f, 1.414560000e+00f, 2.877690000e+00f, 2.862240000e+00f, 2.846790000e+00f, 2.831340000e+00f, 4.319955000e+00f, 4.296510000e+00f, 4.273065000e+00f, 4.249620000e+00f,
                4.417695000e+00f, 4.393710000e+00f, 4.369725000e+00f, 4.345740000e+00f, 4.515435000e+00f, 4.490910000e+00f, 4.466385000e+00f, 4.441860000e+00f, 4.613175000e+00f, 4.588110000e+00f, 4.563045000e+00f, 4.537980000e+00f,
                4.710915000e+00f, 4.685310000e+00f, 4.659705000e+00f, 4.634100000e+00f, 3.138090000e+00f, 3.120840000e+00f, 3.103590000e+00f, 3.086340000e+00f, 1.567545000e+00f, 1.558830000e+00f, 1.550115000e+00f, 1.541400000e+00f,
                1.194468000e+00f, 1.187856000e+00f, 1.181244000e+00f, 1.174632000e+00f, 2.388264000e+00f, 2.374896000e+00f, 2.361528000e+00f, 2.348160000e+00f, 3.580812000e+00f, 3.560544000e+00f, 3.540276000e+00f, 3.520008000e+00f,
                3.656412000e+00f, 3.635712000e+00f, 3.615012000e+00f, 3.594312000e+00f, 3.732012000e+00f, 3.710880000e+00f, 3.689748000e+00f, 3.668616000e+00f, 3.807612000e+00f, 3.786048000e+00f, 3.764484000e+00f, 3.742920000e+00f,
                3.883212000e+00f, 3.861216000e+00f, 3.839220000e+00f, 3.817224000e+00f, 2.583912000e+00f, 2.569104000e+00f, 2.554296000e+00f, 2.539488000e+00f, 1.289316000e+00f, 1.281840000e+00f, 1.274364000e+00f, 1.266888000e+00f,
                9.261990000e-01f, 9.208620000e-01f, 9.155250000e-01f, 9.101880000e-01f, 1.849734000e+00f, 1.838952000e+00f, 1.828170000e+00f, 1.817388000e+00f, 2.770173000e+00f, 2.753838000e+00f, 2.737503000e+00f, 2.721168000e+00f,
                2.824929000e+00f, 2.808270000e+00f, 2.791611000e+00f, 2.774952000e+00f, 2.879685000e+00f, 2.862702000e+00f, 2.845719000e+00f, 2.828736000e+00f, 2.934441000e+00f, 2.917134000e+00f, 2.899827000e+00f, 2.882520000e+00f,
                2.989197000e+00f, 2.971566000e+00f, 2.953935000e+00f, 2.936304000e+00f, 1.986966000e+00f, 1.975104000e+00f, 1.963242000e+00f, 1.951380000e+00f, 9.904230000e-01f, 9.844380000e-01f, 9.784530000e-01f, 9.724680000e-01f,
                6.356820000e-01f, 6.318720000e-01f, 6.280620000e-01f, 6.242520000e-01f, 1.268148000e+00f, 1.260456000e+00f, 1.252764000e+00f, 1.245072000e+00f, 1.897110000e+00f, 1.885464000e+00f, 1.873818000e+00f, 1.862172000e+00f,
                1.932318000e+00f, 1.920456000e+00f, 1.908594000e+00f, 1.896732000e+00f, 1.967526000e+00f, 1.955448000e+00f, 1.943370000e+00f, 1.931292000e+00f, 2.002734000e+00f, 1.990440000e+00f, 1.978146000e+00f, 1.965852000e+00f,
                2.037942000e+00f, 2.025432000e+00f, 2.012922000e+00f, 2.000412000e+00f, 1.353300000e+00f, 1.344888000e+00f, 1.336476000e+00f, 1.328064000e+00f, 6.738900000e-01f, 6.696480000e-01f, 6.654060000e-01f, 6.611640000e-01f,
                3.259410000e-01f, 3.239100000e-01f, 3.218790000e-01f, 3.198480000e-01f, 6.495540000e-01f, 6.454560000e-01f, 6.413580000e-01f, 6.372600000e-01f, 9.706950000e-01f, 9.644940000e-01f, 9.582930000e-01f, 9.520920000e-01f,
                9.876510000e-01f, 9.813420000e-01f, 9.750330000e-01f, 9.687240000e-01f, 1.004607000e+00f, 9.981900000e-01f, 9.917730000e-01f, 9.853560000e-01f, 1.021563000e+00f, 1.015038000e+00f, 1.008513000e+00f, 1.001988000e+00f,
                1.038519000e+00f, 1.031886000e+00f, 1.025253000e+00f, 1.018620000e+00f, 6.889620000e-01f, 6.845040000e-01f, 6.800460000e-01f, 6.755880000e-01f, 3.427410000e-01f, 3.404940000e-01f, 3.382470000e-01f, 3.360000000e-01f,
                4.760970000e-01f, 4.738140000e-01f, 4.715310000e-01f, 4.692480000e-01f, 9.505860000e-01f, 9.459840000e-01f, 9.413820000e-01f, 9.367800000e-01f, 1.423323000e+00f, 1.416366000e+00f, 1.409409000e+00f, 1.402452000e+00f,
                1.445463000e+00f, 1.438398000e+00f, 1.431333000e+00f, 1.424268000e+00f, 1.467603000e+00f, 1.460430000e+00f, 1.453257000e+00f, 1.446084000e+00f, 1.489743000e+00f, 1.482462000e+00f, 1.475181000e+00f, 1.467900000e+00f,
                1.511883000e+00f, 1.504494000e+00f, 1.497105000e+00f, 1.489716000e+00f, 1.005258000e+00f, 1.000296000e+00f, 9.953340000e-01f, 9.903720000e-01f, 5.012490000e-01f, 4.987500000e-01f, 4.962510000e-01f, 4.937520000e-01f,
                9.774660000e-01f, 9.726480000e-01f, 9.678300000e-01f, 9.630120000e-01f, 1.950276000e+00f, 1.940568000e+00f, 1.930860000e+00f, 1.921152000e+00f, 2.918142000e+00f, 2.903472000e+00f, 2.888802000e+00f, 2.874132000e+00f,
                2.961126000e+00f, 2.946240000e+00f, 2.931354000e+00f, 2.916468000e+00f, 3.004110000e+00f, 2.989008000e+00f, 2.973906000e+00f, 2.958804000e+00f, 3.047094000e+00f, 3.031776000e+00f, 3.016458000e+00f, 3.001140000e+00f,
                3.090078000e+00f, 3.074544000e+00f, 3.059010000e+00f, 3.043476000e+00f, 2.053284000e+00f, 2.042856000e+00f, 2.032428000e+00f, 2.022000000e+00f, 1.023162000e+00f, 1.017912000e+00f, 1.012662000e+00f, 1.007412000e+00f,
                1.501083000e+00f, 1.493478000e+00f, 1.485873000e+00f, 1.478268000e+00f, 2.993022000e+00f, 2.977704000e+00f, 2.962386000e+00f, 2.947068000e+00f, 4.475385000e+00f, 4.452246000e+00f, 4.429107000e+00f, 4.405968000e+00f,
                4.537917000e+00f, 4.514454000e+00f, 4.490991000e+00f, 4.467528000e+00f, 4.600449000e+00f, 4.576662000e+00f, 4.552875000e+00f, 4.529088000e+00f, 4.662981000e+00f, 4.638870000e+00f, 4.614759000e+00f, 4.590648000e+00f,
                4.725513000e+00f, 4.701078000e+00f, 4.676643000e+00f, 4.652208000e+00f, 3.138030000e+00f, 3.121632000e+00f, 3.105234000e+00f, 3.088836000e+00f, 1.562715000e+00f, 1.554462000e+00f, 1.546209000e+00f, 1.537956000e+00f,
                2.043924000e+00f, 2.033280000e+00f, 2.022636000e+00f, 2.011992000e+00f, 4.072776000e+00f, 4.051344000e+00f, 4.029912000e+00f, 4.008480000e+00f, 6.085980000e+00f, 6.053616000e+00f, 6.021252000e+00f, 5.988888000e+00f,
                6.166764000e+00f, 6.133968000e+00f, 6.101172000e+00f, 6.068376000e+00f, 6.247548000e+00f, 6.214320000e+00f, 6.181092000e+00f, 6.147864000e+00f, 6.328332000e+00f, 6.294672000e+00f, 6.261012000e+00f, 6.227352000e+00f,
                6.409116000e+00f, 6.375024000e+00f, 6.340932000e+00f, 6.306840000e+00f, 4.253448000e+00f, 4.230576000e+00f, 4.207704000e+00f, 4.184832000e+00f, 2.116884000e+00f, 2.105376000e+00f, 2.093868000e+00f, 2.082360000e+00f,
                2.602965000e+00f, 2.589030000e+00f, 2.575095000e+00f, 2.561160000e+00f, 5.183490000e+00f, 5.155440000e+00f, 5.127390000e+00f, 5.099340000e+00f, 7.740855000e+00f, 7.698510000e+00f, 7.656165000e+00f, 7.613820000e+00f,
                7.838595000e+00f, 7.795710000e+00f, 7.752825000e+00f, 7.709940000e+00f, 7.936335000e+00f, 7.892910000e+00f, 7.849485000e+00f, 7.806060000e+00f, 8.034075000e+00f, 7.990110000e+00f, 7.946145000e+00f, 7.902180000e+00f,
                8.131815000e+00f, 8.087310000e+00f, 8.042805000e+00f, 7.998300000e+00f, 5.393490000e+00f, 5.363640000e+00f, 5.333790000e+00f, 5.303940000e+00f, 2.682645000e+00f, 2.667630000e+00f, 2.652615000e+00f, 2.637600000e+00f,
                2.836065000e+00f, 2.820870000e+00f, 2.805675000e+00f, 2.790480000e+00f, 5.644650000e+00f, 5.614080000e+00f, 5.583510000e+00f, 5.552940000e+00f, 8.425035000e+00f, 8.378910000e+00f, 8.332785000e+00f, 8.286660000e+00f,
                8.522775000e+00f, 8.476110000e+00f, 8.429445000e+00f, 8.382780000e+00f, 8.620515000e+00f, 8.573310000e+00f, 8.526105000e+00f, 8.478900000e+00f, 8.718255000e+00f, 8.670510000e+00f, 8.622765000e+00f, 8.575020000e+00f,
                8.815995000e+00f, 8.767710000e+00f, 8.719425000e+00f, 8.671140000e+00f, 5.844570000e+00f, 5.812200000e+00f, 5.779830000e+00f, 5.747460000e+00f, 2.905665000e+00f, 2.889390000e+00f, 2.873115000e+00f, 2.856840000e+00f,
                3.069165000e+00f, 3.052710000e+00f, 3.036255000e+00f, 3.019800000e+00f, 6.105810000e+00f, 6.072720000e+00f, 6.039630000e+00f, 6.006540000e+00f, 9.109215000e+00f, 9.059310000e+00f, 9.009405000e+00f, 8.959500000e+00f,
                9.206955000e+00f, 9.156510000e+00f, 9.106065000e+00f, 9.055620000e+00f, 9.304695000e+00f, 9.253710000e+00f, 9.202725000e+00f, 9.151740000e+00f, 9.402435000e+00f, 9.350910000e+00f, 9.299385000e+00f, 9.247860000e+00f,
                9.500175000e+00f, 9.448110000e+00f, 9.396045000e+00f, 9.343980000e+00f, 6.295650000e+00f, 6.260760000e+00f, 6.225870000e+00f, 6.190980000e+00f, 3.128685000e+00f, 3.111150000e+00f, 3.093615000e+00f, 3.076080000e+00f,
                3.302265000e+00f, 3.284550000e+00f, 3.266835000e+00f, 3.249120000e+00f, 6.566970000e+00f, 6.531360000e+00f, 6.495750000e+00f, 6.460140000e+00f, 9.793395000e+00f, 9.739710000e+00f, 9.686025000e+00f, 9.632340000e+00f,
                9.891135000e+00f, 9.836910000e+00f, 9.782685000e+00f, 9.728460000e+00f, 9.988875000e+00f, 9.934110000e+00f, 9.879345000e+00f, 9.824580000e+00f, 1.008661500e+01f, 1.003131000e+01f, 9.976005000e+00f, 9.920700000e+00f,
                1.018435500e+01f, 1.012851000e+01f, 1.007266500e+01f, 1.001682000e+01f, 6.746730000e+00f, 6.709320000e+00f, 6.671910000e+00f, 6.634500000e+00f, 3.351705000e+00f, 3.332910000e+00f, 3.314115000e+00f, 3.295320000e+00f,
                3.535365000e+00f, 3.516390000e+00f, 3.497415000e+00f, 3.478440000e+00f, 7.028130000e+00f, 6.990000000e+00f, 6.951870000e+00f, 6.913740000e+00f, 1.047757500e+01f, 1.042011000e+01f, 1.036264500e+01f, 1.030518000e+01f,
                1.057531500e+01f, 1.051731000e+01f, 1.045930500e+01f, 1.040130000e+01f, 1.067305500e+01f, 1.061451000e+01f, 1.055596500e+01f, 1.049742000e+01f, 1.077079500e+01f, 1.071171000e+01f, 1.065262500e+01f, 1.059354000e+01f,
                1.086853500e+01f, 1.080891000e+01f, 1.074928500e+01f, 1.068966000e+01f, 7.197810000e+00f, 7.157880000e+00f, 7.117950000e+00f, 7.078020000e+00f, 3.574725000e+00f, 3.554670000e+00f, 3.534615000e+00f, 3.514560000e+00f,
                2.818356000e+00f, 2.802672000e+00f, 2.786988000e+00f, 2.771304000e+00f, 5.599752000e+00f, 5.568240000e+00f, 5.536728000e+00f, 5.505216000e+00f, 8.343612000e+00f, 8.296128000e+00f, 8.248644000e+00f, 8.201160000e+00f,
                8.419212000e+00f, 8.371296000e+00f, 8.323380000e+00f, 8.275464000e+00f, 8.494812000e+00f, 8.446464000e+00f, 8.398116000e+00f, 8.349768000e+00f, 8.570412000e+00f, 8.521632000e+00f, 8.472852000e+00f, 8.424072000e+00f,
                8.646012000e+00f, 8.596800000e+00f, 8.547588000e+00f, 8.498376000e+00f, 5.722824000e+00f, 5.689872000e+00f, 5.656920000e+00f, 5.623968000e+00f, 2.840628000e+00f, 2.824080000e+00f, 2.807532000e+00f, 2.790984000e+00f,
                2.103291000e+00f, 2.091150000e+00f, 2.079009000e+00f, 2.066868000e+00f, 4.176702000e+00f, 4.152312000e+00f, 4.127922000e+00f, 4.103532000e+00f, 6.219801000e+00f, 6.183054000e+00f, 6.146307000e+00f, 6.109560000e+00f,
                6.274557000e+00f, 6.237486000e+00f, 6.200415000e+00f, 6.163344000e+00f, 6.329313000e+00f, 6.291918000e+00f, 6.254523000e+00f, 6.217128000e+00f, 6.384069000e+00f, 6.346350000e+00f, 6.308631000e+00f, 6.270912000e+00f,
                6.438825000e+00f, 6.400782000e+00f, 6.362739000e+00f, 6.324696000e+00f, 4.259502000e+00f, 4.234032000e+00f, 4.208562000e+00f, 4.183092000e+00f, 2.113083000e+00f, 2.100294000e+00f, 2.087505000e+00f, 2.074716000e+00f,
                1.393194000e+00f, 1.384848000e+00f, 1.376502000e+00f, 1.368156000e+00f, 2.765028000e+00f, 2.748264000e+00f, 2.731500000e+00f, 2.714736000e+00f, 4.115214000e+00f, 4.089960000e+00f, 4.064706000e+00f, 4.039452000e+00f,
                4.150422000e+00f, 4.124952000e+00f, 4.099482000e+00f, 4.074012000e+00f, 4.185630000e+00f, 4.159944000e+00f, 4.134258000e+00f, 4.108572000e+00f, 4.220838000e+00f, 4.194936000e+00f, 4.169034000e+00f, 4.143132000e+00f,
                4.256046000e+00f, 4.229928000e+00f, 4.203810000e+00f, 4.177692000e+00f, 2.813892000e+00f, 2.796408000e+00f, 2.778924000e+00f, 2.761440000e+00f, 1.395114000e+00f, 1.386336000e+00f, 1.377558000e+00f, 1.368780000e+00f,
                6.910890000e-01f, 6.867900000e-01f, 6.824910000e-01f, 6.781920000e-01f, 1.370778000e+00f, 1.362144000e+00f, 1.353510000e+00f, 1.344876000e+00f, 2.038923000e+00f, 2.025918000e+00f, 2.012913000e+00f, 1.999908000e+00f,
                2.055879000e+00f, 2.042766000e+00f, 2.029653000e+00f, 2.016540000e+00f, 2.072835000e+00f, 2.059614000e+00f, 2.046393000e+00f, 2.033172000e+00f, 2.089791000e+00f, 2.076462000e+00f, 2.063133000e+00f, 2.049804000e+00f,
                2.106747000e+00f, 2.093310000e+00f, 2.079873000e+00f, 2.066436000e+00f, 1.392042000e+00f, 1.383048000e+00f, 1.374054000e+00f, 1.365060000e+00f, 6.897450000e-01f, 6.852300000e-01f, 6.807150000e-01f, 6.762000000e-01f,

            };

            float[] x_actual = x.ToFloatArray();

            AssertError.Tolerance(x_expect, x_actual, 1e-7f, 1e-5f, $"mismatch value {inchannels},{kwidth},{inwidth},{batch}");
        }
    }
}
