using AvxBlas;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using System;
using System.Linq;

namespace AvxBlasTest.Connection2DTest {
    [TestClass]
    public class BackwardDataPadZeroTest {
        [TestMethod]
        public void SBackwardDataPadZeroTest() {
            float max_err = 0;

            foreach (uint n in new int[] { 1, 2 }) {
                foreach ((uint iw, uint ih) in new (uint, uint)[] { (1, 1), (1, 2), (4, 3), (5, 8), (16, 15), (17, 28), (32, 30) }) {
                    foreach ((uint kw, uint kh) in new (uint, uint)[] { (1, 3), (3, 1), (3, 3), (3, 5), (5, 3), (7, 7) }) {
                        uint ow = iw, oh = ih;

                        foreach ((uint ic, uint oc) in new (uint, uint)[] { (1, 1), (2, 3), (3, 2), (4, 5), (5, 4), (8, 10), (10, 8),
                                                                            (7, 16), (16, 7), (9, 24), (24, 9), (31, 32), (32, 31), (15, 64), (64, 15) }) {

                            float[] yval = (new float[ow * oh * oc * n]).Select((_, idx) => idx * 1e-3f).ToArray();
                            float[] wval = (new float[kw * kh * ic * oc]).Select((_, idx) => (idx + 1) * 1e-3f).Reverse().ToArray();

                            Map2D y = new((int)oc, (int)ow, (int)oh, (int)n, yval);
                            Filter2D w = new((int)ic, (int)kw, (int)kh, (int)oc, wval);

                            Map2D x = Reference(y, w, (int)iw, (int)kw, (int)ih, (int)kh);

                            Array<float> y_tensor = yval;
                            Array<float> w_tensor = wval;
                            Array<float> x_tensor = new(ic * iw * ih * n, zeroset: false);

                            Convolution2D.BackwardData(n, ic, oc, iw, ih, kw, kh, PadMode.Zero, y_tensor, w_tensor, x_tensor);

                            float[] x_expect = x.ToFloatArray();
                            float[] x_actual = x_tensor;

                            CollectionAssert.AreEqual(yval, (float[])y_tensor);
                            CollectionAssert.AreEqual(wval, (float[])w_tensor);

                            AssertError.Tolerance(x_expect, x_actual, 1e-8f, 1e-6f, ref max_err, $"NG: {ic},{oc},{iw},{ih},{kw},{kh},{n}");

                            Console.WriteLine($"OK: {ic},{oc},{iw},{ih},{kw},{kh},{n}");
                        }
                    }
                }
            }

            Console.WriteLine($"maxerr:{max_err}");
        }

        public static Map2D Reference(Map2D y, Filter2D w, int iw, int kw, int ih, int kh) {
            int inchannels = w.InChannels, outchannels = w.OutChannels, batch = y.Batch;
            int outw = iw, outh = ih;

            if (y.Width != outw || y.Height != outh) {
                throw new ArgumentException("mismatch shape");
            }

            Map2D x = new(inchannels, iw, ih, batch);

            for (int th = 0; th < batch; th++) {
                for (int ky = 0; ky < kh; ky++) {
                    for (int kx = 0; kx < kw; kx++) {
                        for (int oy = 0; oy < outh; oy++) {
                            int iy = ky + oy - kh / 2;
                            if (iy < 0 || iy >= ih) {
                                continue;
                            }

                            for (int ox = 0; ox < outw; ox++) {
                                int ix = kx + ox - kw / 2;
                                if (ix < 0 || ix >= iw) {
                                    continue;
                                }

                                for (int outch = 0; outch < outchannels; outch++) {
                                    double v = y[outch, ox, oy, th];

                                    for (int inch = 0; inch < inchannels; inch++) {
                                        x[inch, ix, iy, th] += v * w[inch, kx, ky, outch];
                                    }
                                }
                            }
                        }
                    }
                }
            }

            return x;
        }

        [TestMethod]
        public void ReferenceTest() {
            int inchannels = 4, outchannels = 6;
            int kwidth = 3, kheight = 5, inwidth = 9, inheight = 13, batch = 2;
            int outwidth = inwidth, outheight = inheight;

            float[] yval = (new float[outwidth * outheight * outchannels * batch]).Select((_, idx) => idx * 1e-3f).ToArray();
            float[] wval = (new float[kwidth * kheight * outchannels * inchannels]).Select((_, idx) => idx * 1e-3f).Reverse().ToArray();

            Map2D y = new(outchannels, outwidth, outheight, batch, yval);
            Filter2D w = new(inchannels, kwidth, kheight, outchannels, wval);

            Map2D x = Reference(y, w, inwidth, kwidth, inheight, kheight);

            float[] x_expect = {
                4.271580000e-01f, 4.250160000e-01f, 4.228740000e-01f, 4.207320000e-01f, 6.661170000e-01f, 6.627420000e-01f, 6.593670000e-01f, 6.559920000e-01f, 7.286490000e-01f, 7.249500000e-01f, 7.212510000e-01f, 7.175520000e-01f,
                7.911810000e-01f, 7.871580000e-01f, 7.831350000e-01f, 7.791120000e-01f, 8.537130000e-01f, 8.493660000e-01f, 8.450190000e-01f, 8.406720000e-01f, 9.162450000e-01f, 9.115740000e-01f, 9.069030000e-01f, 9.022320000e-01f,
                9.787770000e-01f, 9.737820000e-01f, 9.687870000e-01f, 9.637920000e-01f, 1.041309000e+00f, 1.035990000e+00f, 1.030671000e+00f, 1.025352000e+00f, 7.073820000e-01f, 7.037280000e-01f, 7.000740000e-01f, 6.964200000e-01f,
                8.154960000e-01f, 8.113440000e-01f, 8.071920000e-01f, 8.030400000e-01f, 1.251900000e+00f, 1.245456000e+00f, 1.239012000e+00f, 1.232568000e+00f, 1.332684000e+00f, 1.325808000e+00f, 1.318932000e+00f, 1.312056000e+00f,
                1.413468000e+00f, 1.406160000e+00f, 1.398852000e+00f, 1.391544000e+00f, 1.494252000e+00f, 1.486512000e+00f, 1.478772000e+00f, 1.471032000e+00f, 1.575036000e+00f, 1.566864000e+00f, 1.558692000e+00f, 1.550520000e+00f,
                1.655820000e+00f, 1.647216000e+00f, 1.638612000e+00f, 1.630008000e+00f, 1.736604000e+00f, 1.727568000e+00f, 1.718532000e+00f, 1.709496000e+00f, 1.171848000e+00f, 1.165680000e+00f, 1.159512000e+00f, 1.153344000e+00f,
                1.313850000e+00f, 1.307040000e+00f, 1.300230000e+00f, 1.293420000e+00f, 2.000115000e+00f, 1.989630000e+00f, 1.979145000e+00f, 1.968660000e+00f, 2.097855000e+00f, 2.086830000e+00f, 2.075805000e+00f, 2.064780000e+00f,
                2.195595000e+00f, 2.184030000e+00f, 2.172465000e+00f, 2.160900000e+00f, 2.293335000e+00f, 2.281230000e+00f, 2.269125000e+00f, 2.257020000e+00f, 2.391075000e+00f, 2.378430000e+00f, 2.365785000e+00f, 2.353140000e+00f,
                2.488815000e+00f, 2.475630000e+00f, 2.462445000e+00f, 2.449260000e+00f, 2.586555000e+00f, 2.572830000e+00f, 2.559105000e+00f, 2.545380000e+00f, 1.737690000e+00f, 1.728360000e+00f, 1.719030000e+00f, 1.709700000e+00f,
                1.906770000e+00f, 1.896720000e+00f, 1.886670000e+00f, 1.876620000e+00f, 2.879775000e+00f, 2.864430000e+00f, 2.849085000e+00f, 2.833740000e+00f, 2.977515000e+00f, 2.961630000e+00f, 2.945745000e+00f, 2.929860000e+00f,
                3.075255000e+00f, 3.058830000e+00f, 3.042405000e+00f, 3.025980000e+00f, 3.172995000e+00f, 3.156030000e+00f, 3.139065000e+00f, 3.122100000e+00f, 3.270735000e+00f, 3.253230000e+00f, 3.235725000e+00f, 3.218220000e+00f,
                3.368475000e+00f, 3.350430000e+00f, 3.332385000e+00f, 3.314340000e+00f, 3.466215000e+00f, 3.447630000e+00f, 3.429045000e+00f, 3.410460000e+00f, 2.317650000e+00f, 2.305080000e+00f, 2.292510000e+00f, 2.279940000e+00f,
                2.499690000e+00f, 2.486400000e+00f, 2.473110000e+00f, 2.459820000e+00f, 3.759435000e+00f, 3.739230000e+00f, 3.719025000e+00f, 3.698820000e+00f, 3.857175000e+00f, 3.836430000e+00f, 3.815685000e+00f, 3.794940000e+00f,
                3.954915000e+00f, 3.933630000e+00f, 3.912345000e+00f, 3.891060000e+00f, 4.052655000e+00f, 4.030830000e+00f, 4.009005000e+00f, 3.987180000e+00f, 4.150395000e+00f, 4.128030000e+00f, 4.105665000e+00f, 4.083300000e+00f,
                4.248135000e+00f, 4.225230000e+00f, 4.202325000e+00f, 4.179420000e+00f, 4.345875000e+00f, 4.322430000e+00f, 4.298985000e+00f, 4.275540000e+00f, 2.897610000e+00f, 2.881800000e+00f, 2.865990000e+00f, 2.850180000e+00f,
                3.092610000e+00f, 3.076080000e+00f, 3.059550000e+00f, 3.043020000e+00f, 4.639095000e+00f, 4.614030000e+00f, 4.588965000e+00f, 4.563900000e+00f, 4.736835000e+00f, 4.711230000e+00f, 4.685625000e+00f, 4.660020000e+00f,
                4.834575000e+00f, 4.808430000e+00f, 4.782285000e+00f, 4.756140000e+00f, 4.932315000e+00f, 4.905630000e+00f, 4.878945000e+00f, 4.852260000e+00f, 5.030055000e+00f, 5.002830000e+00f, 4.975605000e+00f, 4.948380000e+00f,
                5.127795000e+00f, 5.100030000e+00f, 5.072265000e+00f, 5.044500000e+00f, 5.225535000e+00f, 5.197230000e+00f, 5.168925000e+00f, 5.140620000e+00f, 3.477570000e+00f, 3.458520000e+00f, 3.439470000e+00f, 3.420420000e+00f,
                3.685530000e+00f, 3.665760000e+00f, 3.645990000e+00f, 3.626220000e+00f, 5.518755000e+00f, 5.488830000e+00f, 5.458905000e+00f, 5.428980000e+00f, 5.616495000e+00f, 5.586030000e+00f, 5.555565000e+00f, 5.525100000e+00f,
                5.714235000e+00f, 5.683230000e+00f, 5.652225000e+00f, 5.621220000e+00f, 5.811975000e+00f, 5.780430000e+00f, 5.748885000e+00f, 5.717340000e+00f, 5.909715000e+00f, 5.877630000e+00f, 5.845545000e+00f, 5.813460000e+00f,
                6.007455000e+00f, 5.974830000e+00f, 5.942205000e+00f, 5.909580000e+00f, 6.105195000e+00f, 6.072030000e+00f, 6.038865000e+00f, 6.005700000e+00f, 4.057530000e+00f, 4.035240000e+00f, 4.012950000e+00f, 3.990660000e+00f,
                4.278450000e+00f, 4.255440000e+00f, 4.232430000e+00f, 4.209420000e+00f, 6.398415000e+00f, 6.363630000e+00f, 6.328845000e+00f, 6.294060000e+00f, 6.496155000e+00f, 6.460830000e+00f, 6.425505000e+00f, 6.390180000e+00f,
                6.593895000e+00f, 6.558030000e+00f, 6.522165000e+00f, 6.486300000e+00f, 6.691635000e+00f, 6.655230000e+00f, 6.618825000e+00f, 6.582420000e+00f, 6.789375000e+00f, 6.752430000e+00f, 6.715485000e+00f, 6.678540000e+00f,
                6.887115000e+00f, 6.849630000e+00f, 6.812145000e+00f, 6.774660000e+00f, 6.984855000e+00f, 6.946830000e+00f, 6.908805000e+00f, 6.870780000e+00f, 4.637490000e+00f, 4.611960000e+00f, 4.586430000e+00f, 4.560900000e+00f,
                4.871370000e+00f, 4.845120000e+00f, 4.818870000e+00f, 4.792620000e+00f, 7.278075000e+00f, 7.238430000e+00f, 7.198785000e+00f, 7.159140000e+00f, 7.375815000e+00f, 7.335630000e+00f, 7.295445000e+00f, 7.255260000e+00f,
                7.473555000e+00f, 7.432830000e+00f, 7.392105000e+00f, 7.351380000e+00f, 7.571295000e+00f, 7.530030000e+00f, 7.488765000e+00f, 7.447500000e+00f, 7.669035000e+00f, 7.627230000e+00f, 7.585425000e+00f, 7.543620000e+00f,
                7.766775000e+00f, 7.724430000e+00f, 7.682085000e+00f, 7.639740000e+00f, 7.864515000e+00f, 7.821630000e+00f, 7.778745000e+00f, 7.735860000e+00f, 5.217450000e+00f, 5.188680000e+00f, 5.159910000e+00f, 5.131140000e+00f,
                5.464290000e+00f, 5.434800000e+00f, 5.405310000e+00f, 5.375820000e+00f, 8.157735000e+00f, 8.113230000e+00f, 8.068725000e+00f, 8.024220000e+00f, 8.255475000e+00f, 8.210430000e+00f, 8.165385000e+00f, 8.120340000e+00f,
                8.353215000e+00f, 8.307630000e+00f, 8.262045000e+00f, 8.216460000e+00f, 8.450955000e+00f, 8.404830000e+00f, 8.358705000e+00f, 8.312580000e+00f, 8.548695000e+00f, 8.502030000e+00f, 8.455365000e+00f, 8.408700000e+00f,
                8.646435000e+00f, 8.599230000e+00f, 8.552025000e+00f, 8.504820000e+00f, 8.744175000e+00f, 8.696430000e+00f, 8.648685000e+00f, 8.600940000e+00f, 5.797410000e+00f, 5.765400000e+00f, 5.733390000e+00f, 5.701380000e+00f,
                6.057210000e+00f, 6.024480000e+00f, 5.991750000e+00f, 5.959020000e+00f, 9.037395000e+00f, 8.988030000e+00f, 8.938665000e+00f, 8.889300000e+00f, 9.135135000e+00f, 9.085230000e+00f, 9.035325000e+00f, 8.985420000e+00f,
                9.232875000e+00f, 9.182430000e+00f, 9.131985000e+00f, 9.081540000e+00f, 9.330615000e+00f, 9.279630000e+00f, 9.228645000e+00f, 9.177660000e+00f, 9.428355000e+00f, 9.376830000e+00f, 9.325305000e+00f, 9.273780000e+00f,
                9.526095000e+00f, 9.474030000e+00f, 9.421965000e+00f, 9.369900000e+00f, 9.623835000e+00f, 9.571230000e+00f, 9.518625000e+00f, 9.466020000e+00f, 6.377370000e+00f, 6.342120000e+00f, 6.306870000e+00f, 6.271620000e+00f,
                4.894728000e+00f, 4.867248000e+00f, 4.839768000e+00f, 4.812288000e+00f, 7.298172000e+00f, 7.256736000e+00f, 7.215300000e+00f, 7.173864000e+00f, 7.373772000e+00f, 7.331904000e+00f, 7.290036000e+00f, 7.248168000e+00f,
                7.449372000e+00f, 7.407072000e+00f, 7.364772000e+00f, 7.322472000e+00f, 7.524972000e+00f, 7.482240000e+00f, 7.439508000e+00f, 7.396776000e+00f, 7.600572000e+00f, 7.557408000e+00f, 7.514244000e+00f, 7.471080000e+00f,
                7.676172000e+00f, 7.632576000e+00f, 7.588980000e+00f, 7.545384000e+00f, 7.751772000e+00f, 7.707744000e+00f, 7.663716000e+00f, 7.619688000e+00f, 5.133576000e+00f, 5.104080000e+00f, 5.074584000e+00f, 5.045088000e+00f,
                3.699990000e+00f, 3.678408000e+00f, 3.656826000e+00f, 3.635244000e+00f, 5.513157000e+00f, 5.480622000e+00f, 5.448087000e+00f, 5.415552000e+00f, 5.567913000e+00f, 5.535054000e+00f, 5.502195000e+00f, 5.469336000e+00f,
                5.622669000e+00f, 5.589486000e+00f, 5.556303000e+00f, 5.523120000e+00f, 5.677425000e+00f, 5.643918000e+00f, 5.610411000e+00f, 5.576904000e+00f, 5.732181000e+00f, 5.698350000e+00f, 5.664519000e+00f, 5.630688000e+00f,
                5.786937000e+00f, 5.752782000e+00f, 5.718627000e+00f, 5.684472000e+00f, 5.841693000e+00f, 5.807214000e+00f, 5.772735000e+00f, 5.738256000e+00f, 3.866166000e+00f, 3.843072000e+00f, 3.819978000e+00f, 3.796884000e+00f,
                5.355198000e+00f, 5.327784000e+00f, 5.300370000e+00f, 5.272956000e+00f, 7.982361000e+00f, 7.941078000e+00f, 7.899795000e+00f, 7.858512000e+00f, 8.044893000e+00f, 8.003286000e+00f, 7.961679000e+00f, 7.920072000e+00f,
                8.107425000e+00f, 8.065494000e+00f, 8.023563000e+00f, 7.981632000e+00f, 8.169957000e+00f, 8.127702000e+00f, 8.085447000e+00f, 8.043192000e+00f, 8.232489000e+00f, 8.189910000e+00f, 8.147331000e+00f, 8.104752000e+00f,
                8.295021000e+00f, 8.252118000e+00f, 8.209215000e+00f, 8.166312000e+00f, 8.357553000e+00f, 8.314326000e+00f, 8.271099000e+00f, 8.227872000e+00f, 5.534334000e+00f, 5.505408000e+00f, 5.476482000e+00f, 5.447556000e+00f,
                7.184040000e+00f, 7.146192000e+00f, 7.108344000e+00f, 7.070496000e+00f, 1.070362800e+01f, 1.064664000e+01f, 1.058965200e+01f, 1.053266400e+01f, 1.078441200e+01f, 1.072699200e+01f, 1.066957200e+01f, 1.061215200e+01f,
                1.086519600e+01f, 1.080734400e+01f, 1.074949200e+01f, 1.069164000e+01f, 1.094598000e+01f, 1.088769600e+01f, 1.082941200e+01f, 1.077112800e+01f, 1.102676400e+01f, 1.096804800e+01f, 1.090933200e+01f, 1.085061600e+01f,
                1.110754800e+01f, 1.104840000e+01f, 1.098925200e+01f, 1.093010400e+01f, 1.118833200e+01f, 1.112875200e+01f, 1.106917200e+01f, 1.100959200e+01f, 7.405608000e+00f, 7.365744000e+00f, 7.325880000e+00f, 7.286016000e+00f,
                9.021810000e+00f, 8.972880000e+00f, 8.923950000e+00f, 8.875020000e+00f, 1.343569500e+01f, 1.336203000e+01f, 1.328836500e+01f, 1.321470000e+01f, 1.353343500e+01f, 1.345923000e+01f, 1.338502500e+01f, 1.331082000e+01f,
                1.363117500e+01f, 1.355643000e+01f, 1.348168500e+01f, 1.340694000e+01f, 1.372891500e+01f, 1.365363000e+01f, 1.357834500e+01f, 1.350306000e+01f, 1.382665500e+01f, 1.375083000e+01f, 1.367500500e+01f, 1.359918000e+01f,
                1.392439500e+01f, 1.384803000e+01f, 1.377166500e+01f, 1.369530000e+01f, 1.402213500e+01f, 1.394523000e+01f, 1.386832500e+01f, 1.379142000e+01f, 9.277170000e+00f, 9.225720000e+00f, 9.174270000e+00f, 9.122820000e+00f,
                9.614730000e+00f, 9.562560000e+00f, 9.510390000e+00f, 9.458220000e+00f, 1.431535500e+01f, 1.423683000e+01f, 1.415830500e+01f, 1.407978000e+01f, 1.441309500e+01f, 1.433403000e+01f, 1.425496500e+01f, 1.417590000e+01f,
                1.451083500e+01f, 1.443123000e+01f, 1.435162500e+01f, 1.427202000e+01f, 1.460857500e+01f, 1.452843000e+01f, 1.444828500e+01f, 1.436814000e+01f, 1.470631500e+01f, 1.462563000e+01f, 1.454494500e+01f, 1.446426000e+01f,
                1.480405500e+01f, 1.472283000e+01f, 1.464160500e+01f, 1.456038000e+01f, 1.490179500e+01f, 1.482003000e+01f, 1.473826500e+01f, 1.465650000e+01f, 9.857130000e+00f, 9.802440000e+00f, 9.747750000e+00f, 9.693060000e+00f,
                1.020765000e+01f, 1.015224000e+01f, 1.009683000e+01f, 1.004142000e+01f, 1.519501500e+01f, 1.511163000e+01f, 1.502824500e+01f, 1.494486000e+01f, 1.529275500e+01f, 1.520883000e+01f, 1.512490500e+01f, 1.504098000e+01f,
                1.539049500e+01f, 1.530603000e+01f, 1.522156500e+01f, 1.513710000e+01f, 1.548823500e+01f, 1.540323000e+01f, 1.531822500e+01f, 1.523322000e+01f, 1.558597500e+01f, 1.550043000e+01f, 1.541488500e+01f, 1.532934000e+01f,
                1.568371500e+01f, 1.559763000e+01f, 1.551154500e+01f, 1.542546000e+01f, 1.578145500e+01f, 1.569483000e+01f, 1.560820500e+01f, 1.552158000e+01f, 1.043709000e+01f, 1.037916000e+01f, 1.032123000e+01f, 1.026330000e+01f,
                1.080057000e+01f, 1.074192000e+01f, 1.068327000e+01f, 1.062462000e+01f, 1.607467500e+01f, 1.598643000e+01f, 1.589818500e+01f, 1.580994000e+01f, 1.617241500e+01f, 1.608363000e+01f, 1.599484500e+01f, 1.590606000e+01f,
                1.627015500e+01f, 1.618083000e+01f, 1.609150500e+01f, 1.600218000e+01f, 1.636789500e+01f, 1.627803000e+01f, 1.618816500e+01f, 1.609830000e+01f, 1.646563500e+01f, 1.637523000e+01f, 1.628482500e+01f, 1.619442000e+01f,
                1.656337500e+01f, 1.647243000e+01f, 1.638148500e+01f, 1.629054000e+01f, 1.666111500e+01f, 1.656963000e+01f, 1.647814500e+01f, 1.638666000e+01f, 1.101705000e+01f, 1.095588000e+01f, 1.089471000e+01f, 1.083354000e+01f,
                1.139349000e+01f, 1.133160000e+01f, 1.126971000e+01f, 1.120782000e+01f, 1.695433500e+01f, 1.686123000e+01f, 1.676812500e+01f, 1.667502000e+01f, 1.705207500e+01f, 1.695843000e+01f, 1.686478500e+01f, 1.677114000e+01f,
                1.714981500e+01f, 1.705563000e+01f, 1.696144500e+01f, 1.686726000e+01f, 1.724755500e+01f, 1.715283000e+01f, 1.705810500e+01f, 1.696338000e+01f, 1.734529500e+01f, 1.725003000e+01f, 1.715476500e+01f, 1.705950000e+01f,
                1.744303500e+01f, 1.734723000e+01f, 1.725142500e+01f, 1.715562000e+01f, 1.754077500e+01f, 1.744443000e+01f, 1.734808500e+01f, 1.725174000e+01f, 1.159701000e+01f, 1.153260000e+01f, 1.146819000e+01f, 1.140378000e+01f,
                1.198641000e+01f, 1.192128000e+01f, 1.185615000e+01f, 1.179102000e+01f, 1.783399500e+01f, 1.773603000e+01f, 1.763806500e+01f, 1.754010000e+01f, 1.793173500e+01f, 1.783323000e+01f, 1.773472500e+01f, 1.763622000e+01f,
                1.802947500e+01f, 1.793043000e+01f, 1.783138500e+01f, 1.773234000e+01f, 1.812721500e+01f, 1.802763000e+01f, 1.792804500e+01f, 1.782846000e+01f, 1.822495500e+01f, 1.812483000e+01f, 1.802470500e+01f, 1.792458000e+01f,
                1.832269500e+01f, 1.822203000e+01f, 1.812136500e+01f, 1.802070000e+01f, 1.842043500e+01f, 1.831923000e+01f, 1.821802500e+01f, 1.811682000e+01f, 1.217697000e+01f, 1.210932000e+01f, 1.204167000e+01f, 1.197402000e+01f,
                1.257933000e+01f, 1.251096000e+01f, 1.244259000e+01f, 1.237422000e+01f, 1.871365500e+01f, 1.861083000e+01f, 1.850800500e+01f, 1.840518000e+01f, 1.881139500e+01f, 1.870803000e+01f, 1.860466500e+01f, 1.850130000e+01f,
                1.890913500e+01f, 1.880523000e+01f, 1.870132500e+01f, 1.859742000e+01f, 1.900687500e+01f, 1.890243000e+01f, 1.879798500e+01f, 1.869354000e+01f, 1.910461500e+01f, 1.899963000e+01f, 1.889464500e+01f, 1.878966000e+01f,
                1.920235500e+01f, 1.909683000e+01f, 1.899130500e+01f, 1.888578000e+01f, 1.930009500e+01f, 1.919403000e+01f, 1.908796500e+01f, 1.898190000e+01f, 1.275693000e+01f, 1.268604000e+01f, 1.261515000e+01f, 1.254426000e+01f,
                1.317225000e+01f, 1.310064000e+01f, 1.302903000e+01f, 1.295742000e+01f, 1.959331500e+01f, 1.948563000e+01f, 1.937794500e+01f, 1.927026000e+01f, 1.969105500e+01f, 1.958283000e+01f, 1.947460500e+01f, 1.936638000e+01f,
                1.978879500e+01f, 1.968003000e+01f, 1.957126500e+01f, 1.946250000e+01f, 1.988653500e+01f, 1.977723000e+01f, 1.966792500e+01f, 1.955862000e+01f, 1.998427500e+01f, 1.987443000e+01f, 1.976458500e+01f, 1.965474000e+01f,
                2.008201500e+01f, 1.997163000e+01f, 1.986124500e+01f, 1.975086000e+01f, 2.017975500e+01f, 2.006883000e+01f, 1.995790500e+01f, 1.984698000e+01f, 1.333689000e+01f, 1.326276000e+01f, 1.318863000e+01f, 1.311450000e+01f,
                1.376517000e+01f, 1.369032000e+01f, 1.361547000e+01f, 1.354062000e+01f, 2.047297500e+01f, 2.036043000e+01f, 2.024788500e+01f, 2.013534000e+01f, 2.057071500e+01f, 2.045763000e+01f, 2.034454500e+01f, 2.023146000e+01f,
                2.066845500e+01f, 2.055483000e+01f, 2.044120500e+01f, 2.032758000e+01f, 2.076619500e+01f, 2.065203000e+01f, 2.053786500e+01f, 2.042370000e+01f, 2.086393500e+01f, 2.074923000e+01f, 2.063452500e+01f, 2.051982000e+01f,
                2.096167500e+01f, 2.084643000e+01f, 2.073118500e+01f, 2.061594000e+01f, 2.105941500e+01f, 2.094363000e+01f, 2.082784500e+01f, 2.071206000e+01f, 1.391685000e+01f, 1.383948000e+01f, 1.376211000e+01f, 1.368474000e+01f,
                1.085892000e+01f, 1.079774400e+01f, 1.073656800e+01f, 1.067539200e+01f, 1.614337200e+01f, 1.605139200e+01f, 1.595941200e+01f, 1.586743200e+01f, 1.621897200e+01f, 1.612656000e+01f, 1.603414800e+01f, 1.594173600e+01f,
                1.629457200e+01f, 1.620172800e+01f, 1.610888400e+01f, 1.601604000e+01f, 1.637017200e+01f, 1.627689600e+01f, 1.618362000e+01f, 1.609034400e+01f, 1.644577200e+01f, 1.635206400e+01f, 1.625835600e+01f, 1.616464800e+01f,
                1.652137200e+01f, 1.642723200e+01f, 1.633309200e+01f, 1.623895200e+01f, 1.659697200e+01f, 1.650240000e+01f, 1.640782800e+01f, 1.631325600e+01f, 1.096298400e+01f, 1.089979200e+01f, 1.083660000e+01f, 1.077340800e+01f,
                8.021502000e+00f, 7.974648000e+00f, 7.927794000e+00f, 7.880940000e+00f, 1.191960900e+01f, 1.184916600e+01f, 1.177872300e+01f, 1.170828000e+01f, 1.197436500e+01f, 1.190359800e+01f, 1.183283100e+01f, 1.176206400e+01f,
                1.202912100e+01f, 1.195803000e+01f, 1.188693900e+01f, 1.181584800e+01f, 1.208387700e+01f, 1.201246200e+01f, 1.194104700e+01f, 1.186963200e+01f, 1.213863300e+01f, 1.206689400e+01f, 1.199515500e+01f, 1.192341600e+01f,
                1.219338900e+01f, 1.212132600e+01f, 1.204926300e+01f, 1.197720000e+01f, 1.224814500e+01f, 1.217575800e+01f, 1.210337100e+01f, 1.203098400e+01f, 8.086590000e+00f, 8.038224000e+00f, 7.989858000e+00f, 7.941492000e+00f,

            };

            float[] x_actual = x.ToFloatArray();

            AssertError.Tolerance(x_expect, x_actual, 1e-7f, 1e-5f, $"mismatch value {inchannels},{kwidth},{inwidth},{batch}");
        }
    }
}
